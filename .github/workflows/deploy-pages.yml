name: Deploy Ammonia Inventory Forecast to GitHub Pages

on:
  schedule:
    # 毎日 JST 07:00 に自動実行 (UTC 22:00 前日 = JST 07:00)
    - cron: '0 22 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm ci

      - name: Install Python dependencies
        working-directory: backend/ai_pipeline
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare data (Fill missing actuals)
        working-directory: backend/ai_pipeline
        run: python src/prepare_data.py

      - name: Run training and prediction pipeline
        working-directory: backend/ai_pipeline
        run: python src/run_full_system.py

      - name: Set build time
        run: echo "NEXT_PUBLIC_BUILD_TIME=$(TZ=Asia/Tokyo date +'%Y/%m/%d %H:%M')" >> $GITHUB_ENV

      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_BUILD_TIME: ${{ env.NEXT_PUBLIC_BUILD_TIME }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'out'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Commit updated data
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add backend/ai_pipeline/data/predictions.csv backend/ai_pipeline/data/training_data.csv
          git diff --staged --quiet || git commit -m "chore: Update data (predictions & training) [skip ci]"
          git push

      - name: Create Issue on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const issueTitle = `⚠️ デプロイ失敗検出 (${today})`;
            
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-error'
            });
            
            const todayIssue = existingIssues.data.find(issue => issue.title.includes(today));
            
            if (!todayIssue) {
              const timestamp = new Date().toISOString();
              const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                labels: ['deployment-error', 'automated'],
                body: `## デプロイが失敗しました\n\n` +
                      `**検出日時**: ${timestamp}\n\n` +
                      `### エラー情報\n` +
                      `ワークフローの実行中にエラーが発生しました。\n\n` +
                      `### 推奨アクション\n` +
                      `1. [GitHub Actions ログ](${runUrl})を確認\n` +
                      `2. ビルドエラーの原因を特定\n` +
                      `3. コードの修正とコミット\n\n` +
                      `詳細は上記のログリンクを確認してください。`
              });
              console.log('新しいIssueを作成しました: ' + issueTitle);
            } else {
              console.log('本日のIssueは既に存在します: ' + todayIssue.title);
            }
